<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cosmatrix - Spin to Lock</title>
    <style>
        body {
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .omnitrix-container {
            position: relative;
            width: 350px;
            height: 350px;
            border-radius: 50%;
            background: #000;
            /* Outer glowing rim */
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.2), inset 0 0 20px #000;
            border: 5px solid #111;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* The container that holds the image and spins */
        #dial-container {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            will-change: transform;
            /* No transition by default so dragging is instant */
        }

        #dial-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            pointer-events: none;
            filter: drop-shadow(0 0 10px #ff00ff);
        }

        /* --- ANIMATION CLASS --- */
        /* This class is added via JS when we want it to spin smoothly */
        .spinning-to-lock {
            transition: transform 1.5s cubic-bezier(0.25, 1, 0.5, 1); /* Starts fast, slows down at end */
        }

    </style>
</head>
<body>

    <div class="omnitrix-container" id="touch-zone">
        <div id="dial-container">
            <img id="dial-image" src="image_1.jpg" alt="Dial">
        </div>
    </div>

    <script>
        const touchZone = document.getElementById('touch-zone');
        const dialContainer = document.getElementById('dial-container');
        const dialImage = document.getElementById('dial-image');

        // --- IMAGES ---
        // 0 deg = Slide to Choose (image_1.jpg)
        // 90 deg = Whitening (image_3.jpg)
        // 180 deg = Anti-Aging (image_4.jpg)
        // 270 deg = Weight (image_2.jpg)
        const sectors = [
            { src: "image_1.jpg" }, // 0
            { src: "image_3.jpg" }, // 1 (90)
            { src: "image_4.jpg" }, // 2 (180)
            { src: "image_2.jpg" }  // 3 (270)
        ];
        
        // The final destination image
        const thankYouImage = "image_5.jpg";

        // Preload
        const preloadImg = new Image(); preloadImg.src = thankYouImage;
        sectors.forEach(s => { const img = new Image(); img.src = s.src; });

        let isDragging = false;
        let isLocked = false; // Prevents interaction after selection
        let startAngle = 0;
        let currentRotation = 0;

        function getAngle(x, y) {
            const rect = touchZone.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            return Math.atan2(y - centerY, x - centerX) * (180 / Math.PI) + 90;
        }

        // --- DRAG LOGIC ---
        function handleStart(e) {
            if (isLocked) return;
            if(e.cancelable) e.preventDefault();
            
            // Remove transition class so dragging is instant
            dialContainer.classList.remove('spinning-to-lock');
            
            isDragging = true;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            // Calculate offset
            let fingerAngle = getAngle(clientX, clientY);
            startAngle = fingerAngle - currentRotation;
        }

        function handleMove(e) {
            if (!isDragging || isLocked) return;
            if(e.cancelable) e.preventDefault();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            currentRotation = getAngle(clientX, clientY) - startAngle;
            dialContainer.style.transform = `rotate(${currentRotation}deg)`;

            // Swap images based on sector
            let normalizedRot = currentRotation % 360;
            if (normalizedRot < 0) normalizedRot += 360;
            let activeSectorIndex = Math.floor((normalizedRot + 45) / 90) % 4;
            
            let targetSrc = sectors[activeSectorIndex].src;
            if (!dialImage.src.includes(targetSrc)) {
                dialImage.src = targetSrc;
                if (navigator.vibrate) navigator.vibrate(10);
            }
        }

        function handleEnd() {
            isDragging = false;
        }

        // --- SPIN TO THANK YOU LOGIC ---
        
        // Detect Tap
        let tapStartTime = 0;
        touchZone.addEventListener('touchstart', (e) => { tapStartTime = new Date().getTime(); handleStart(e); }, {passive: false});
        touchZone.addEventListener('touchend', (e) => { 
            handleEnd();
            if (new Date().getTime() - tapStartTime < 200) lockInSelection();
        });
        
        // Mouse support
        touchZone.addEventListener('mousedown', (e) => { tapStartTime = new Date().getTime(); handleStart(e); });
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', () => { 
            handleEnd();
            if (new Date().getTime() - tapStartTime < 200) lockInSelection();
        });
        window.addEventListener('touchmove', handleMove, {passive: false});


        function lockInSelection() {
            if (isLocked) return;
            isLocked = true;
            isDragging = false;

            // 1. Calculate the Target Rotation
            // We want it to spin at least 2 full times (720 degrees)
            // And land exactly at 0 degrees (upright) relative to current rotation.
            
            // Round current rotation to nearest full circle, then add 2 circles (720)
            // This ensures it spins FORWARD to the next upright position
            let nextUprightPosition = Math.ceil(currentRotation / 360) * 360;
            if (nextUprightPosition === currentRotation) nextUprightPosition += 360; // Ensure it moves if already at 0
            
            let targetRotation = nextUprightPosition + 720; // Add extra spins

            // 2. Apply CSS Transition
            dialContainer.classList.add('spinning-to-lock');
            
            // 3. Trigger the spin
            // Small timeout to allow CSS class to apply
            requestAnimationFrame(() => {
                dialContainer.style.transform = `rotate(${targetRotation}deg)`;
            });

            // 4. Haptic Buzz
            if (navigator.vibrate) navigator.vibrate([50, 50, 50, 50, 200]);

            // 5. Swap to "Thank You" image MID-SPIN
            // We do this after 300ms so the wheel is moving fast and blurring
            // This hides the image swap, making it look like it "landed" on it.
            setTimeout(() => {
                dialImage.src = thankYouImage;
            }, 500);

            // 6. Optional: Reset after 5 seconds to allow trying again
            setTimeout(() => {
                // Reset internal logic without animation
                dialContainer.classList.remove('spinning-to-lock');
                // Remove the extra rotations so the numbers don't get huge
                currentRotation = currentRotation % 360; 
                dialContainer.style.transform = `rotate(${currentRotation}deg)`;
                
                // Switch back to start image
                dialImage.src = sectors[0].src;
                isLocked = false;
            }, 5000);
        }

    </script>
</body>
</html>