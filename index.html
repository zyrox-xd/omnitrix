<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cosmatrix - Lock In</title>
    <style>
        body {
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .omnitrix-container {
            position: relative;
            width: 350px;
            height: 350px;
            border-radius: 50%;
            background: #000;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.25), inset 0 0 30px #000;
            border: 4px solid #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* The layer that rotates */
        #dial-rotating-layer {
            width: 100%;
            height: 100%;
            position: relative;
            border-radius: 50%;
            will-change: transform;
            /* Transition is managed by JS classes */
        }

        /* Smooth transition class for the "Locking" movement */
        .locking-movement {
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy lock effect */
        }

        /* Images */
        .dial-face {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            transition: opacity 0.4s ease-out; /* Fast fade */
            filter: drop-shadow(0 0 10px #ff00ff);
        }

        #front-dial-image {
            z-index: 2;
            opacity: 1;
        }

        #back-thankyou-image {
            z-index: 1;
            opacity: 0;
            transform: scale(0.9); /* Starts slightly smaller */
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }

        /* --- LOCKED STATE --- */
        .is-locked #front-dial-image {
            opacity: 0;
        }

        .is-locked #back-thankyou-image {
            opacity: 1;
            transform: scale(1); /* Popping effect */
            filter: drop-shadow(0 0 30px #ff00ff) brightness(1.2);
        }

    </style>
</head>
<body>

    <div class="omnitrix-container" id="touch-zone">
        <div id="dial-rotating-layer">
            <img id="front-dial-image" class="dial-face" src="image_1.jpg" alt="Dial">
            <img id="back-thankyou-image" class="dial-face" src="image_5.jpg" alt="Thank You">
        </div>
    </div>

    <script>
        const touchZone = document.getElementById('touch-zone');
        const rotatingLayer = document.getElementById('dial-rotating-layer');
        const frontImage = document.getElementById('front-dial-image');

        // Config
        const sectors = [
            { src: "image_1.jpg" }, // 0
            { src: "image_3.jpg" }, // 1 (90)
            { src: "image_4.jpg" }, // 2 (180)
            { src: "image_2.jpg" }  // 3 (270)
        ];

        // Preload
        sectors.forEach(s => { const img = new Image(); img.src = s.src; });

        let isDragging = false;
        let isLocked = false;
        let startAngle = 0;
        let currentRotation = 0;

        function getAngle(x, y) {
            const rect = touchZone.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            return Math.atan2(y - centerY, x - centerX) * (180 / Math.PI) + 90;
        }

        // --- DRAG LOGIC ---
        function handleStart(e) {
            if (isLocked) return;
            if(e.cancelable) e.preventDefault();
            
            // Remove smooth transition so dragging is instant and follows finger
            rotatingLayer.classList.remove('locking-movement');
            
            isDragging = true;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            startAngle = getAngle(clientX, clientY) - currentRotation;
        }

        function handleMove(e) {
            if (!isDragging || isLocked) return;
            if(e.cancelable) e.preventDefault();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            currentRotation = getAngle(clientX, clientY) - startAngle;
            rotatingLayer.style.transform = `rotate(${currentRotation}deg)`;

            // Swap active image
            let normalizedRot = currentRotation % 360;
            if (normalizedRot < 0) normalizedRot += 360;
            let activeSectorIndex = Math.floor((normalizedRot + 45) / 90) % 4;
            
            if (!frontImage.src.includes(sectors[activeSectorIndex].src)) {
                frontImage.src = sectors[activeSectorIndex].src;
                if (navigator.vibrate) navigator.vibrate(10);
            }
        }

        function handleEnd() {
            isDragging = false;
        }

        // --- TAP TO LOCK LOGIC ---
        let tapStartTime = 0;
        touchZone.addEventListener('touchstart', (e) => { tapStartTime = new Date().getTime(); handleStart(e); }, {passive: false});
        touchZone.addEventListener('touchend', (e) => { 
            handleEnd();
            if (new Date().getTime() - tapStartTime < 200) lockIn();
        });
        
        // Mouse
        touchZone.addEventListener('mousedown', (e) => { tapStartTime = new Date().getTime(); handleStart(e); });
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', () => { 
            handleEnd();
            if (new Date().getTime() - tapStartTime < 200) lockIn();
        });
        window.addEventListener('touchmove', handleMove, {passive: false});


        function lockIn() {
            if (isLocked) return;
            isLocked = true;
            isDragging = false;

            // 1. Calculate the shortest path to "Upright" (0 degrees relative)
            // If we are at 350, go to 360. If at 10, go to 0. If at -10, go to 0.
            // This ensures we don't spin wildly, just snap to center.
            let nearestUpright = Math.round(currentRotation / 360) * 360;
            
            // 2. Add transition class for smooth movement
            rotatingLayer.classList.add('locking-movement');

            // 3. Trigger the visual changes
            requestAnimationFrame(() => {
                // Rotate to center
                rotatingLayer.style.transform = `rotate(${nearestUpright}deg)`;
                // Update rotation var so subsequent drags start from correct spot
                currentRotation = nearestUpright; 
                
                // Fade swap
                touchZone.classList.add('is-locked');
            });

            // 4. Haptic Feedback (Heavy Thud)
            if (navigator.vibrate) navigator.vibrate([70]);

            // 5. Reset after 3 seconds
            setTimeout(() => {
                touchZone.classList.remove('is-locked');
                isLocked = false;
                // Switch front image back to start
                frontImage.src = sectors[0].src;
            }, 3000);
        }

    </script>
</body>
</html>